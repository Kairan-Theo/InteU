<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>InteU â€” Company Profile</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="css/styles.css" />
    <style>
      /* Profile-specific styles */

      .profile-container { 
        display: grid; 
        grid-template-columns: 1fr 1fr; 
        gap: 32px; 
      }
      .profile-section { 
        background: var(--card); 
        border: 1px solid rgba(0,0,0,0.06); 
        border-radius: 14px; 
        box-shadow: var(--shadow); 
        padding: 24px; 
        margin-bottom: 24px; 
      }
      .profile-section h3 { 
        color: var(--primary); 
        margin-bottom: 20px; 
        padding-bottom: 12px; 
        border-bottom: 2px solid rgba(75, 123, 229, 0.1); 
      }
      .company-header { 
        grid-column: 1 / -1; 
        text-align: center; 
        padding: 32px 24px; 
      }
      .company-logo { 
        width: 120px; 
        height: 120px; 
        border-radius: 50%; 
        background: var(--primary); 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        color: white; 
        font-size: 48px; 
        font-weight: 700; 
        margin: 0 auto 16px; 
        position: relative; 
        cursor: pointer; 
        transition: transform 0.2s ease; 
      }
      .company-logo:hover { 
        transform: scale(1.05); 
      }
      .logo-upload { 
        position: absolute; 
        bottom: 0; 
        right: 0; 
        width: 36px; 
        height: 36px; 
        background: white; 
        border: 2px solid var(--primary); 
        border-radius: 50%; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        cursor: pointer; 
        font-size: 16px; 
        color: var(--primary); 
      }
      .company-name { 
        font-size: 28px; 
        font-weight: 700; 
        color: var(--text); 
        margin-bottom: 8px; 
      }
      .company-industry { 
        color: var(--muted); 
        font-size: 16px; 
        margin-bottom: 16px; 
      }
      .company-stats { 
        display: flex; 
        justify-content: center; 
        gap: 32px; 
        margin-top: 20px; 
      }
      .stat-item { 
        text-align: center; 
      }
      .stat-number { 
        font-size: 24px; 
        font-weight: 700; 
        color: var(--primary); 
      }
      .stat-label { 
        font-size: 14px; 
        color: var(--muted); 
      }
      .form-section {
        margin-bottom: 24px;
      }
      .form-section:last-child {
        margin-bottom: 0;
      }
      .social-links { 
        display: grid; 
        grid-template-columns: 1fr 1fr; 
        gap: 16px; 
      }
      .file-upload {
        position: relative;
        display: inline-block;
        cursor: pointer;
      }
      .file-upload input[type="file"] {
        position: absolute;
        opacity: 0;
        width: 100%;
        height: 100%;
        cursor: pointer;
      }
      .file-upload-label {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        background: var(--primary);
        color: white;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.2s ease;
      }
      .file-upload-label:hover {
        background: #5a6fd8;
      }
      .password-requirements {
        background: #f8f9fa;
        border: 1px solid rgba(0,0,0,0.1);
        border-radius: 8px;
        padding: 16px;
        margin-top: 8px;
        font-size: 14px;
      }
      .requirement {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 4px;
      }
      .requirement.valid {
        color: #28a745;
      }
      .requirement.invalid {
        color: #dc3545;
      }
      .tabs {
        display: flex;
        border-bottom: 1px solid rgba(0,0,0,0.1);
        margin-bottom: 24px;
      }
      .tab {
        padding: 12px 24px;
        background: none;
        border: none;
        cursor: pointer;
        color: var(--muted);
        font-size: 16px;
        transition: all 0.2s ease;
      }
      .tab.active {
        color: var(--primary);
        border-bottom: 2px solid var(--primary);
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
      .notification-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid rgba(0,0,0,0.06);
      }
      .notification-item:last-child {
        border-bottom: none;
      }
      .notification-info {
        flex: 1;
      }
      .notification-title {
        font-weight: 600;
        margin-bottom: 4px;
      }
      .notification-desc {
        font-size: 14px;
        color: var(--muted);
      }
      .toggle-switch {
        position: relative;
        width: 50px;
        height: 24px;
        background: #ccc;
        border-radius: 12px;
        cursor: pointer;
        transition: background-color 0.2s ease;
      }
      .toggle-switch.active {
        background: var(--primary);
      }
      .toggle-switch::after {
        content: '';
        position: absolute;
        top: 2px;
        left: 2px;
        width: 20px;
        height: 20px;
        background: white;
        border-radius: 50%;
        transition: transform 0.2s ease;
      }
      .toggle-switch.active::after {
        transform: translateX(26px);
      }
      .danger-zone { 
        border: 1px dashed rgba(239, 68, 68, 0.5); 
        background: rgba(239, 68, 68, 0.06); 
        border-radius: 12px; 
        padding: 16px; 
      }
      .danger-zone h4 { 
        margin: 0 0 8px; 
        color: var(--danger); 
      }
      .btn-danger { 
        background: var(--danger); 
        color: #fff; 
        border: none; 
        border-radius: 10px; 
        height: 40px; 
        padding: 0 14px; 
        cursor: pointer; 
        font-weight: 700; 
      }
      @media (max-width: 768px) { 
        .profile-container { 
          grid-template-columns: 1fr; 
        } 
      }
    </style>
  </head>

  <body data-page="company-profile">
    <header class="site-header" aria-label="Company Navigation">
      <div class="container header-inner">
        <a class="logo" href="dashboard.html" aria-label="InteU Company Portal">
            <span class="logo-mark"><img src="../images/image1.jpg" alt="InteU logo" /></span> InteU
        </a>
        <nav class="nav">
          <a href="dashboard.html" data-i18n="nav.dashboard">Dashboard</a>
          <a href="manage-internships.html" data-i18n="nav.manage">Manage Internships</a>
          <a href="post-internship.html" data-i18n="nav.post">Post Internship</a>
          <a href="view-applicants.html" data-i18n="nav.applicants">View Applicants</a>
          <a href="messages.html" class="nav-link message-icon" id="messageIcon" aria-label="Messages" title="Messages">
            <span style="font-size: 28px;">ðŸ’¬</span>
            <span class="notification-badge" id="notificationBadge">3</span>
          </a>
        </nav>
        <div class="actions">
          <input type="checkbox" id="dark-mode" aria-label="Toggle theme" hidden>
          <label for="dark-mode" class="theme-switch" aria-label="Toggle theme"></label>
          <button id="toggleLang" class="btn small" aria-label="Toggle language">à¹„à¸—à¸¢ / EN</button>
          <a href="profile.html" class="icon-btn active" aria-label="Profile" title="Profile">
            <img src="../../images/user.png" alt="Profile" width="28" height="28">
          </a>
          <a href="../pages/auth/company-login.html" class="btn small primary" data-i18n="nav.logout">Logout</a>
        </div>
      </div>
    </header>

    <main class="container">

      <div class="profile-section company-header">
        <div class="company-logo" id="companyLogo" title="Upload logo">
          <span id="logoInitials">CO</span>
          <div class="logo-upload">ðŸ“·</div>
          <input type="file" id="logoUpload" accept="image/*" style="display:none" />
        </div>
        <div class="company-name" id="headerCompanyName">Company</div>
        <div class="company-industry" id="headerCompanyIndustry">Industry â€¢ Size</div>
        <div class="company-stats">
          <div class="stat-item">
            <div class="stat-number" id="statActiveInternships">0</div>
            <div class="stat-label">Active Internships</div>
          </div>
          <div class="stat-item">
            <div class="stat-number" id="statTotalApplications">0</div>
            <div class="stat-label">Total Applications</div>
          </div>
          <div class="stat-item">
            <div class="stat-number" id="statHiredInterns">0</div>
            <div class="stat-label">Hired Interns</div>
          </div>
        </div>
      </div>

      <div class="profile-section" style="grid-column: 1 / -1;">
        <div class="tabs">
          <button class="tab active" data-tab="company-info">Company Information</button>
          <button class="tab" data-tab="account-settings">Account Settings</button>
          <button class="tab" data-tab="notifications">Notifications</button>
          <button class="tab" data-tab="billing">Billing & Plans</button>
        </div>

        <div id="company-info" class="tab-content active">
          <div class="profile-container">
            <div>
              <div class="profile-section">
                <h3>Basic Information</h3>
                <label><span>Company Name *</span><input type="text" id="companyName" required /></label>
                <label>
                  <span>Industry *</span>
                  <select id="industry" required>
                    <option value="">Select Industry</option>
                    <option value="technology">Technology</option>
                    <option value="finance">Finance</option>
                    <option value="healthcare">Healthcare</option>
                    <option value="education">Education</option>
                    <option value="retail">Retail</option>
                    <option value="manufacturing">Manufacturing</option>
                    <option value="consulting">Consulting</option>
                    <option value="media">Media & Entertainment</option>
                    <option value="nonprofit">Non-Profit</option>
                    <option value="other">Other</option>
                  </select>
                </label>
                <label><span>Company Size *</span>
                  <select id="companySize" required>
                    <option value="">Select Size</option>
                    <option value="1-10">1-10 employees</option>
                    <option value="11-50">11-50 employees</option>
                    <option value="51-200">51-200 employees</option>
                    <option value="201-500">201-500 employees</option>
                    <option value="501-1000">501-1000 employees</option>
                    <option value="1000+">1000+ employees</option>
                  </select>
                </label>
                <label><span>Founded Year</span><input type="number" id="foundedYear" min="1800" max="2099" placeholder="e.g., 2015" /></label>
                <label><span>Company Description *</span><textarea id="companyDescription" required rows="4" placeholder="Describe your company, mission, and what makes it unique..."></textarea></label>
              </div>
            </div>

            <div>
              <div class="profile-section">
                <h3>Contact Information</h3>
                <label><span>Business Email *</span><input type="email" id="businessEmail" required /></label>
                <label><span>Phone Number *</span><input type="tel" id="phoneNumber" required /></label>
                <label><span>Website</span><input type="url" id="website" placeholder="https://www.company.com" /></label>
                <label><span>Address *</span><textarea id="address" required rows="3" placeholder="Full business address including city and postal code..."></textarea></label>
              </div>

              <div class="profile-section">
                <h3>Social Media</h3>
                <div class="social-links">
                  <label><span>LinkedIn</span><input type="url" id="linkedin" placeholder="https://linkedin.com/company/..." /></label>
                  <label><span>Twitter</span><input type="url" id="twitter" placeholder="https://twitter.com/..." /></label>
                  <label><span>Facebook</span><input type="url" id="facebook" placeholder="https://facebook.com/..." /></label>
                  <label><span>Instagram</span><input type="url" id="instagram" placeholder="https://instagram.com/..." /></label>
                </div>
              </div>
            </div>
          </div>

          <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
            <button type="button" class="btn secondary" id="btnCancelCompany">Cancel</button>
            <button type="button" class="btn primary" id="btnSaveCompany">Save Changes</button>
          </div>
        </div>

        <div id="account-settings" class="tab-content">
          <div class="profile-container">
            <div>
              <div class="profile-section">
                <h3>Account Information</h3>
                <label><span>Account Email *</span><input type="email" id="accountEmail" required /></label>
                <label><span>Account Manager Name *</span><input type="text" id="managerName" required /></label>
                <label><span>Manager Title</span><input type="text" id="managerTitle" /></label>
              </div>

              <div class="profile-section">
                <h3>Change Password</h3>
                <label><span>Current Password</span><input type="password" id="currentPassword" /></label>
                <label><span>New Password</span><input type="password" id="newPassword" /></label>
                <label><span>Confirm New Password</span><input type="password" id="confirmPassword" /></label>
                <div class="password-requirements">
                  <div class="requirement" id="lengthReq"><span>âœ—</span> At least 8 characters</div>
                  <div class="requirement" id="upperReq"><span>âœ—</span> One uppercase letter</div>
                  <div class="requirement" id="lowerReq"><span>âœ—</span> One lowercase letter</div>
                  <div class="requirement" id="numberReq"><span>âœ—</span> One number</div>
                </div>
              </div>
            </div>

            <div>
              <div class="profile-section">
                <h3>Account Preferences</h3>
                <label><span>Time Zone</span>
                  <select id="timezone">
                    <option value="UTC-8">Pacific Time (UTC-8)</option>
                    <option value="UTC-5">Eastern Time (UTC-5)</option>
                    <option value="UTC-6">Central Time (UTC-6)</option>
                    <option value="UTC-7">Mountain Time (UTC-7)</option>
                    <option value="UTC+0">UTC</option>
                    <option value="UTC+7">Bangkok (UTC+7)</option>
                  </select>
                </label>
                <label><span>Language</span>
                  <select id="language">
                    <option value="en">English</option>
                    <option value="th">à¹„à¸—à¸¢ (Thai)</option>
                    <option value="es">EspaÃ±ol</option>
                    <option value="fr">FranÃ§ais</option>
                  </select>
                </label>
                <label><span>Date Format</span>
                  <select id="dateFormat">
                    <option value="MM/DD/YYYY">MM/DD/YYYY</option>
                    <option value="DD/MM/YYYY">DD/MM/YYYY</option>
                    <option value="YYYY-MM-DD">YYYY-MM-DD</option>
                  </select>
                </label>
              </div>

              <div class="profile-section">
                <h3>Account Actions</h3>
                <div class="row" style="gap:12px; flex-wrap: wrap;">
                  <button class="btn secondary" id="btnExport">Export Account Data</button>
                  <button class="btn" style="background:#dc3545; color:#fff;" id="btnDeactivate">Deactivate Account</button>
                </div>

                <div class="danger-zone" style="margin-top:16px;">
                  <h4>Danger Zone</h4>
                  <p class="muted" style="margin:0 0 10px;">Deleting your account permanently removes your data (this device) and ends your session.</p>
                  <button class="btn-danger" id="btnDelete">Delete Account Permanently</button>
                </div>
              </div>
            </div>
          </div>

          <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
            <button type="button" class="btn secondary" id="btnCancelAccount">Cancel</button>
            <button type="button" class="btn primary" id="btnSaveAccount">Save Changes</button>
          </div>
        </div>

        <div id="notifications" class="tab-content">
          <div class="profile-section">
            <h3>Email Notifications</h3>
            <div class="notification-item">
              <div class="notification-info">
                <div class="notification-title">New Applications</div>
                <div class="notification-desc">Get notified when someone applies</div>
              </div>
              <div class="toggle-switch" data-key="notif_new_apps"></div>
            </div>

            <div class="notification-item">
              <div class="notification-info">
                <div class="notification-title">Application Updates</div>
                <div class="notification-desc">Status changes</div>
              </div>
              <div class="toggle-switch" data-key="notif_app_updates"></div>
            </div>

            <div class="notification-item">
              <div class="notification-info">
                <div class="notification-title">Messages</div>
                <div class="notification-desc">New messages from applicants</div>
              </div>
              <div class="toggle-switch" data-key="notif_messages"></div>
            </div>

            <div class="notification-item">
              <div class="notification-info">
                <div class="notification-title">Internship Expiry</div>
                <div class="notification-desc">Expiry reminders</div>
              </div>
              <div class="toggle-switch" data-key="notif_expiry"></div>
            </div>
          </div>

          <div class="profile-section">
            <h3>Push Notifications</h3>
            <div class="notification-item">
              <div class="notification-info">
                <div class="notification-title">Urgent Messages</div>
                <div class="notification-desc">Immediate attention needed</div>
              </div>
              <div class="toggle-switch" data-key="push_urgent"></div>
            </div>

            <div class="notification-item">
              <div class="notification-info">
                <div class="notification-title">Daily Summary</div>
                <div class="notification-desc">Daily digest</div>
              </div>
              <div class="toggle-switch" data-key="push_daily"></div>
            </div>
          </div>

          <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
            <button type="button" class="btn primary" id="btnSaveNotifs">Save Preferences</button>
          </div>
        </div>

        <div id="billing" class="tab-content">
          <div class="profile-container">
            <div>
              <div class="profile-section">
                <h3>Current Plan</h3>
                <div style="background:#f8f9fa; border:1px solid rgba(0,0,0,0.1); border-radius:8px; padding:20px;">
                  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                    <h4 style="margin:0; color:var(--primary);">Professional Plan</h4>
                    <span style="background:var(--primary); color:#fff; padding:4px 12px; border-radius:16px; font-size:12px;">ACTIVE</span>
                  </div>
                  <p class="muted" style="margin:0 0 12px;">Up to 50 active internship postings</p>
                  <div style="font-size:24px; font-weight:700;">$99/month</div>
                  <div style="margin-top:16px;">
                    <button class="btn secondary small">Change Plan</button>
                    <button class="btn small" style="margin-left:8px;">Cancel Subscription</button>
                  </div>
                </div>
              </div>

              <div class="profile-section">
                <h3>Billing History</h3>
                <div style="border:1px solid rgba(0,0,0,0.1); border-radius:8px; overflow:hidden;">
                  <div style="background:#f8f9fa; padding:12px 16px; border-bottom:1px solid rgba(0,0,0,0.1); font-weight:600;">Recent Invoices</div>
                  <div style="padding:16px;">
                    <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid rgba(0,0,0,0.06);">
                      <div><div>January 2024</div><div class="muted" style="font-size:14px;">Professional Plan</div></div>
                      <div style="text-align:right;"><div>$99.00</div><a href="#" style="font-size:14px; color:var(--primary);">Download</a></div>
                    </div>
                    <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid rgba(0,0,0,0.06);">
                      <div><div>December 2023</div><div class="muted" style="font-size:14px;">Professional Plan</div></div>
                      <div style="text-align:right;"><div>$99.00</div><a href="#" style="font-size:14px; color:var(--primary);">Download</a></div>
                    </div>
                    <div style="display:flex; justify-content:space-between; padding:8px 0;">
                      <div><div>November 2023</div><div class="muted" style="font-size:14px;">Professional Plan</div></div>
                      <div style="text-align:right;"><div>$99.00</div><a href="#" style="font-size:14px; color:var(--primary);">Download</a></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div>
              <div class="profile-section">
                <h3>Payment Method</h3>
                <div style="background:#f8f9fa; border:1px solid rgba(0,0,0,0.1); border-radius:8px; padding:20px;">
                  <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div style="display:flex; align-items:center; gap:12px;">
                      <div style="width:40px; height:24px; background:var(--primary); border-radius:4px; display:flex; align-items:center; justify-content:center; color:#fff; font-size:12px; font-weight:600;">VISA</div>
                      <div>
                        <div>â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ 4242</div>
                        <div class="muted" style="font-size:14px;">Expires 12/25</div>
                      </div>
                    </div>
                    <button class="btn secondary small">Update</button>
                  </div>
                </div>
              </div>

              <div class="profile-section">
                <h3>Billing Address</h3>
                <label><span>Company Name</span><input type="text" id="billCompany" /></label>
                <label><span>Address</span><textarea rows="2" id="billAddress"></textarea></label>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
                  <label><span>Country</span>
                    <select id="billCountry">
                      <option value="US">United States</option>
                      <option value="CA">Canada</option>
                      <option value="UK">United Kingdom</option>
                      <option value="TH">Thailand</option>
                    </select>
                  </label>
                  <label><span>Tax ID</span><input type="text" id="billTaxId" placeholder="Optional" /></label>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div><!-- /tabs wrapper -->
    </main>

    <footer class="site-footer">
      <div class="container footer-grid">
        <div>
          <h4>Help & Support</h4>
          <ul>
            <li><a href="#" id="contactUsLink">Contact us</a></li>
            <li><a href="#" id="faqLink">FAQ</a></li>
          </ul>
        </div>
        <div>
          <h4>Privacy</h4>
          <ul>
            <li><a href="#" id="privacyPolicyLink">Privacy Policy</a></li>
            <li><a href="#" id="pdpaNoticeLink">PDPA Notice</a></li>
          </ul>
        </div>
        <div>
          <h4>InteU</h4>
          <p class="muted">Trusted internships for global learners.</p>
        </div>
      </div>
    </footer>

    <style>
      /* Footer styling */
      .site-footer {
        background: var(--card);
        border-top: 1px solid rgba(0,0,0,0.06);
        padding: 40px 0;
        margin-top: auto;
      }
      .footer-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 32px;
      }
      .footer-grid h4 {
        color: var(--text);
        margin-bottom: 16px;
      }
      .footer-grid ul {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .footer-grid li {
        margin-bottom: 8px;
      }
      .footer-grid a {
        color: var(--muted);
        text-decoration: none;
        transition: color 0.2s ease;
      }
      .footer-grid a:hover {
        color: var(--primary);
      }
      .theme-switch {
        position: relative;
        width: 48px;
        height: 24px;
        background: #ccc;
        border-radius: 12px;
        cursor: pointer;
        transition: background-color 0.2s ease;
      }
      .theme-switch::after {
        content: '';
        position: absolute;
        top: 2px;
        left: 2px;
        width: 20px;
        height: 20px;
        background: white;
        border-radius: 50%;
        transition: transform 0.2s ease;
      }
      #dark-mode:checked + .theme-switch {
        background: var(--primary);
      }
      #dark-mode:checked + .theme-switch::after {
        transform: translateX(24px);
      }
      .btn.secondary {
        background: var(--bg);
        color: var(--text);
        border: 1px solid rgba(0,0,0,0.1);
      }
      .btn.secondary:hover {
        background: rgba(0,0,0,0.05);
      }
      body.dark .btn.secondary {
        background: var(--card);
        border-color: rgba(255,255,255,0.1);
      }
      body.dark .btn.secondary:hover {
        background: rgba(255,255,255,0.05);
      }
      .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
      }
    </style>

    <div id="toastContainer" class="toast-container" aria-live="polite" aria-atomic="true"></div>

    <script>
      /************ THEME ************/
      const THEME_KEY = 'theme';
      function applyTheme(theme) {
        document.body.classList.toggle('dark', theme === 'dark');
        const toggle = document.getElementById('dark-mode');
        if (toggle) toggle.checked = theme === 'dark';
      }
      function getStoredTheme() { return localStorage.getItem(THEME_KEY) || 'light'; }
      function setStoredTheme(t) { localStorage.setItem(THEME_KEY, t); }

      /************ NEW STORAGE KEYS ************/
      const AUTH_KEY = 'inteu_company_auth';          // { email }
      const PROFILES_KEY = 'inteu_company_profiles';  // { [email]: profile }
      const NOTIF_NS = 'companyNotifications';        // per-user: companyNotifications:<email>

      /************ HELPERS ************/
      const $ = sel => document.querySelector(sel);
      const initialsFromName = (name='') => name.trim().split(/\s+/).slice(0,2).map(s=>s[0]?.toUpperCase()||'').join('') || 'CO';

      function readProfiles(){ try { return JSON.parse(localStorage.getItem(PROFILES_KEY) || '{}'); } catch { return {}; } }
      function writeProfiles(obj){ localStorage.setItem(PROFILES_KEY, JSON.stringify(obj)); }
      function readNotifs(email){ try { return JSON.parse(localStorage.getItem(`${NOTIF_NS}:${email}`) || '{}'); } catch { return {}; } }
      function writeNotifs(email, obj){ localStorage.setItem(`${NOTIF_NS}:${email}`, JSON.stringify(obj)); }

      /************ LEGACY MIGRATION ************/
      function migrateLegacyIfAny() {
        // old single profile
        try {
          const legacy = JSON.parse(localStorage.getItem('inteu_company_profile') || 'null');
          if (legacy && legacy.businessEmail) {
            const map = readProfiles();
            map[legacy.businessEmail.toLowerCase()] = { ...legacy };
            writeProfiles(map);
            localStorage.removeItem('inteu_company_profile');
          }
        } catch {}
        // very old: 'companyAccount'
        try {
          const oldAcc = JSON.parse(localStorage.getItem('companyAccount') || 'null');
          if (oldAcc && oldAcc.businessEmail) {
            const map = readProfiles();
            const email = String(oldAcc.businessEmail).toLowerCase();
            map[email] = {
              companyName: oldAcc.companyName || 'Company',
              industry: oldAcc.industry || '',
              companySize: oldAcc.companySize || '',
              foundedYear: oldAcc.foundedYear || '',
              companyDescription: oldAcc.description || '',
              businessEmail: email,
              phoneNumber: oldAcc.phoneNumber || '',
              website: oldAcc.website || '',
              linkedin: oldAcc.socials?.linkedin || '',
              address: oldAcc.address || '',
              managerName: oldAcc.account?.managerName || '',
              managerTitle: oldAcc.account?.managerTitle || '',
              internshipAreas: [],
              settings: { timezone: oldAcc.account?.timezone || 'UTC+7', language: oldAcc.account?.language || 'en', dateFormat: oldAcc.account?.dateFormat || 'YYYY-MM-DD' },
              stats: { activeInternships: oldAcc.stats?.active ?? 0, totalApplications: oldAcc.stats?.apps ?? 0, hired: oldAcc.stats?.hired ?? 0 },
              createdAt: Date.now(),
              logoDataUrl: oldAcc.logoDataUrl || ''
            };
            writeProfiles(map);
            localStorage.removeItem('companyAccount');
          }
        } catch {}
      }

      /************ AUTH GUARD ************/
      function getAuthedEmail() {
        try {
          const a = JSON.parse(localStorage.getItem(AUTH_KEY) || 'null');
          return a?.email || null;
        } catch { return null; }
      }

      /************ PAGE INIT ************/
      document.addEventListener('DOMContentLoaded', () => {
        // Theme
        applyTheme(getStoredTheme());
        const themeToggle = document.getElementById('dark-mode');
        if (themeToggle) themeToggle.addEventListener('change', (e) => { const t = e.target.checked ? 'dark' : 'light'; applyTheme(t); setStoredTheme(t); });

        // Auth
        const email = getAuthedEmail();
        if (!email) { window.location.replace('auth/login.html'); return; }

        migrateLegacyIfAny();
        loadAccountIntoUI(email);
        initTabs();
        initLogoUpload(email);
        initFormButtons(email);
        initNotificationToggles(email);
        initLogout();
      });

      function loadAccountIntoUI(email) {
        const map = readProfiles();
        let acc = map[email];
        if (!acc) {
          // if somehow missing, create a minimal stub so UI is writable
          acc = {
            companyName: "Your Company",
            industry: "", companySize: "", foundedYear: "",
            companyDescription: "",
            businessEmail: email,
            phoneNumber: "", website: "", linkedin: "", address: "",
            managerName: "", managerTitle: "",
            settings: { timezone:'UTC+7', language:'en', dateFormat:'YYYY-MM-DD' },
            stats: { activeInternships: 0, totalApplications: 0, hired: 0 },
            logoDataUrl: ""
          };
          map[email] = acc; writeProfiles(map);
        }

        // Header
        $('#headerCompanyName').textContent = acc.companyName || 'Company';
        const industryLabel = (acc.industry || '').replace(/(^|\s|-)\S/g, s=>s.toUpperCase());
        $('#headerCompanyIndustry').textContent = `${industryLabel || 'â€”'} â€¢ ${acc.companySize || 'â€”'}`;
        $('#statActiveInternships').textContent = acc.stats?.activeInternships ?? acc.stats?.active ?? 0;
        $('#statTotalApplications').textContent = acc.stats?.totalApplications ?? acc.stats?.apps ?? 0;
        $('#statHiredInterns').textContent = acc.stats?.hired ?? 0;

        // Logo
        renderLogo(acc);

        // Company info form
        $('#companyName').value = acc.companyName || '';
        $('#industry').value = acc.industry || '';
        $('#companySize').value = acc.companySize || '';
        $('#foundedYear').value = acc.foundedYear || '';
        $('#companyDescription').value = acc.companyDescription || '';
        $('#businessEmail').value = acc.businessEmail || '';
        $('#phoneNumber').value = acc.phoneNumber || '';
        $('#website').value = acc.website || '';
        $('#address').value = acc.address || '';
        $('#linkedin').value = acc.linkedin || '';
        $('#twitter').value = acc.twitter || '';
        $('#facebook').value = acc.facebook || '';
        $('#instagram').value = acc.instagram || '';

        // Account settings
        $('#accountEmail').value = acc.businessEmail || '';
        $('#managerName').value = acc.managerName || '';
        $('#managerTitle').value = acc.managerTitle || '';
        $('#timezone').value = acc.settings?.timezone || 'UTC+7';
        $('#language').value = acc.settings?.language || 'en';
        $('#dateFormat').value = acc.settings?.dateFormat || 'YYYY-MM-DD';

        // Billing demo defaults
        $('#billCompany').value = acc.companyName || '';
        $('#billAddress').value = acc.billing?.address || acc.address || '';
        $('#billCountry').value = acc.billing?.country || 'TH';
        $('#billTaxId').value = acc.billing?.taxId || '';
      }

      function renderLogo(acc) {
        const logo = $('#companyLogo');
        const initialsEl = $('#logoInitials');
        if (acc.logoDataUrl) {
          logo.style.backgroundImage = `url(${acc.logoDataUrl})`;
          logo.style.backgroundSize = 'cover';
          logo.style.backgroundPosition = 'center';
          initialsEl.style.display = 'none';
        } else {
          logo.style.backgroundImage = 'url(../images/user.png)';
          logo.style.backgroundSize = 'cover';
          logo.style.backgroundPosition = 'center';
          initialsEl.style.display = 'none';
        }
      }

      function initLogoUpload(email) {
        const input = $('#logoUpload');
        $('#companyLogo').addEventListener('click', () => input.click());
        input.addEventListener('change', (e) => {
          const file = e.target.files?.[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = (ev) => {
            const map = readProfiles();
            const acc = map[email] || {};
            acc.logoDataUrl = ev.target.result;
            map[email] = acc;
            writeProfiles(map);
            renderLogo(acc);
          };
          reader.readAsDataURL(file);
        });
      }

      function initTabs() {
        document.querySelectorAll('.tab').forEach(btn => {
          btn.addEventListener('click', (evt) => {
            document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById(btn.getAttribute('data-tab')).classList.add('active');
          });
        });
      }

      function initFormButtons(email) {
        $('#btnSaveCompany').addEventListener('click', () => saveCompanyInfo(email));
        $('#btnCancelCompany').addEventListener('click', () => loadAccountIntoUI(email));

        $('#btnSaveAccount').addEventListener('click', () => saveAccountSettings(email));
        $('#btnCancelAccount').addEventListener('click', () => loadAccountIntoUI(email));

        $('#btnExport').addEventListener('click', () => exportData(email));
        $('#btnDeactivate').addEventListener('click', () => deactivateAccount());
        $('#btnDelete').addEventListener('click', () => deleteAccountPermanently(email));

        // Live password reqs
        const newPw = $('#newPassword');
        if (newPw) newPw.addEventListener('input', validatePassword);
      }

      function validatePassword() {
        const pw = $('#newPassword').value || '';
        const reqs = { length: pw.length >= 8, upper: /[A-Z]/.test(pw), lower: /[a-z]/.test(pw), number: /\d/.test(pw) };
        setReq('lengthReq', reqs.length); setReq('upperReq', reqs.upper); setReq('lowerReq', reqs.lower); setReq('numberReq', reqs.number);
      }
      function setReq(id, ok) {
        const el = document.getElementById(id);
        if (!el) return;
        el.className = `requirement ${ok ? 'valid' : 'invalid'}`;
        el.querySelector('span').textContent = ok ? 'âœ“' : 'âœ—';
      }

      function saveCompanyInfo(email) {
        const fields = ['companyName','industry','companySize','companyDescription','businessEmail','phoneNumber','address'];
        for (const id of fields) { const el = document.getElementById(id); if (!el.value.trim()) { el.focus(); return; } }

        const map = readProfiles();
        const acc = map[email] || {};

        // If user changed email, we should move the profile to the new key
        const newEmail = $('#businessEmail').value.trim().toLowerCase();
        const keyChanged = newEmail && newEmail !== email;

        const updated = {
          ...acc,
          companyName: $('#companyName').value.trim(),
          industry: $('#industry').value,
          companySize: $('#companySize').value,
          foundedYear: $('#foundedYear').value ? parseInt($('#foundedYear').value, 10) : '',
          companyDescription: $('#companyDescription').value.trim(),
          businessEmail: newEmail || email,
          phoneNumber: $('#phoneNumber').value.trim(),
          website: $('#website').value.trim(),
          address: $('#address').value.trim(),
          linkedin: $('#linkedin').value.trim(),
          twitter: $('#twitter').value.trim(),
          facebook: $('#facebook').value.trim(),
          instagram: $('#instagram').value.trim()
        };

        if (keyChanged) {
          delete map[email];
          map[newEmail] = updated;
          // also update auth email to keep session consistent
          localStorage.setItem(AUTH_KEY, JSON.stringify({ email: newEmail, loggedInAt: Date.now() }));
        } else {
          map[email] = updated;
        }

        writeProfiles(map);

        // Update header
        $('#headerCompanyName').textContent = updated.companyName;
        $('#headerCompanyIndustry').textContent = `${updated.industry.replace(/(^|\s|-)\S/g, s=>s.toUpperCase())} â€¢ ${updated.companySize}`;
        renderLogo(updated);
      }

      function saveAccountSettings(email) {
        const map = readProfiles();
        const acc = map[email] || {};
        acc.businessEmail = $('#accountEmail').value.trim().toLowerCase() || acc.businessEmail || email;
        acc.managerName = $('#managerName').value.trim();
        acc.managerTitle = $('#managerTitle').value.trim();
        acc.settings = acc.settings || {};
        acc.settings.timezone = $('#timezone').value;
        acc.settings.language = $('#language').value;
        acc.settings.dateFormat = $('#dateFormat').value;

        // "Change password" demo only: store base64 (not real security)
        const npw = $('#newPassword').value;
        const cpw = $('#confirmPassword').value;
        if (npw || cpw) {
          if (npw !== cpw) return;
          if (!(npw.length >= 8 && /[A-Z]/.test(npw) && /[a-z]/.test(npw) && /\d/.test(npw))) return;
          acc.account = acc.account || {};
          acc.account.passwordHash = btoa(unescape(encodeURIComponent(npw)));
        }

        // if email changed in account settings, move key
        if (acc.businessEmail !== email) {
          delete map[email];
          map[acc.businessEmail] = acc;
          localStorage.setItem(AUTH_KEY, JSON.stringify({ email: acc.businessEmail, loggedInAt: Date.now() }));
        } else {
          map[email] = acc;
        }
        writeProfiles(map);

        // Clear password inputs after save
        $('#currentPassword').value = '';
        $('#newPassword').value = '';
        $('#confirmPassword').value = '';
        validatePassword();

        // refresh UI banner bits
        loadAccountIntoUI(acc.businessEmail);
      }

      function initNotificationToggles(email) {
        const state = readNotifs(email);
        document.querySelectorAll('.toggle-switch').forEach(sw => {
          const key = sw.getAttribute('data-key');
          if (state[key]) sw.classList.add('active');
          sw.addEventListener('click', () => sw.classList.toggle('active'));
        });
        $('#btnSaveNotifs').addEventListener('click', () => {
          const st = {};
          document.querySelectorAll('.toggle-switch').forEach(sw => {
            const key = sw.getAttribute('data-key');
            st[key] = sw.classList.contains('active');
          });
          writeNotifs(email, st);
        });
      }

      function exportData(email) {
        const map = readProfiles();
        const acc = map[email] || {};
        const notifs = readNotifs(email) || {};
        const dump = JSON.stringify({ account: acc, notifications: notifs }, null, 2);
        const blob = new Blob([dump], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `inteu-company-data-${email}.json`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }

      function deactivateAccount() {
        localStorage.removeItem(AUTH_KEY);
        window.location.href = 'auth/login.html';
      }

      function deleteAccountPermanently(email) {
        const map = readProfiles();
        delete map[email];
        writeProfiles(map);
        localStorage.removeItem(`${NOTIF_NS}:${email}`);
        localStorage.removeItem(AUTH_KEY);
        window.location.href = 'index.html';
      }

      function initLogout() {
        const handler = (e) => {
          e.preventDefault();
          localStorage.removeItem(AUTH_KEY);
          window.location.href = 'auth/login.html';
        };
        $('#logoutLink').addEventListener('click', handler);
        $('#logoutLink2').addEventListener('click', handler);
      }
    </script>
  </body>
</html>